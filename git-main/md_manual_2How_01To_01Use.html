<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NNP STM Generic Remote Module: How To Use</title>
<link rel="icon" href="cosmiic-icon.png" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeDarkModeToggle.init()
        </script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
        <script type="text/javascript">
            DoxygenAwesomeInteractiveToc.init()
        </script>
<script type="text/javascript">
  $(function () {
    var repoName = window.location.pathname.split('/')[1];
    $.get('/' + repoName + '/version_selector.html', function (data) {
        // Inject version selector HTML into the page
        $('#projectnumber').html(data);
        // Event listener to handle version selection
        document.getElementById('versionSelector').addEventListener('change', function () {
            var selectedVersion = this.value;
            window.location.href = '/' + repoName + '/' + selectedVersion + '/index.html';
        });
        // Set the selected option based on the current version
        var currentVersion = window.location.pathname.split('/')[2];
        $('#versionSelector').val(currentVersion);
    });
  });
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="cosmiic-icon.png"/></td>
  <td id="projectalign">
   <div id="projectname">NNP STM Generic Remote Module<span id="projectnumber">&#160;git-main</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_manual_2How_01To_01Use.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">How To Use</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#autotoc_md19">Directories</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md20">Root</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md21">Core/Src</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md22">Core/Inc</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md23">Core/app</a>
        <ul>
          <li class="level3">
            <a href="#autotoc_md24">module Folder</a>
          </li>
          <li class="level3">
            <a href="#autotoc_md25">Object Dictionary</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md26">Restricted Peripherals</a>
  </li>
  <li class="level1">
    <a href="#autotoc_md27">Configuration Differences</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md28">Core/Src/system_stm32l4xx.c</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md29">STM32L433RCTXP_FLASH.ld</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md30">Object Dictionary</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md31">Default/Common Entries</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md32">Adding Entries</a>
        <ul>
          <li class="level3">
            <a href="#autotoc_md33">Creating Variables</a>
          </li>
          <li class="level3">
            <a href="#autotoc_md34">Defining Object Dictionary Structures</a>
          </li>
          <li class="level3">
            <a href="#autotoc_md35">Registering Object Dictionary Entries</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#autotoc_md36">Adding Callbacks</a>
        <ul>
          <li class="level3">
            <a href="#autotoc_md37">Registering an Object Dictionary Callback to a Function</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#autotoc_md38">Add to Restore List</a>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#autotoc_md39">Adding Functionality</a>
    <ul>
      <li class="level2">
        <a href="#autotoc_md40">STM_RM.ioc</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md19"></a>
Directories</h1>
<h2><a class="anchor" id="autotoc_md20"></a>
Root</h2>
<p>The root directory is the base of the project. Many important files relating to project configuration are located here. The <code>.ioc</code> file is used to generate configuration code in STM32CubeMX, the <code>.launch</code> files configure debugging parameters, and the <code>.project</code> file defines the project configuration in STM32CubeIDE.</p>
<dl class="section warning"><dt>Warning</dt><dd>Many of the configuration files are particular about directory and files names. You will most likely need to rename the .ioc file, and create a new launch configuration when cloning the repository from Github.</dd></dl>
<h2><a class="anchor" id="autotoc_md21"></a>
Core/Src</h2>
<p>The Src (or source) directory contains most of the operational code of the CanFest implementation. Specific details of each of the files can be found under Topics-&gt;CANFestival.</p>
<p>This directory also contains <a class="el" href="main_8c.html" title=": Main program body">main.c</a>, which contains the main initialization code of the module, configuring system clocks, peripherals used for communication with the CAN network, and peripherals used for internal state management.</p>
<p>The main file in this directory that will be modified for user implemtation is <a class="el" href="nmtSlave_8c.html">nmtSlave.c</a>, which defines functionality on reception of a specific NMT command.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Core/Inc</h2>
<p>The Inc (or include) directory contains the header files for files within the Core/Src directory.</p>
<p>The main file in this directory that will be modified for user implementation is <a class="el" href="def_8h.html">def.h</a>, which defines NMT commands the module is able to receive.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Core/app</h2>
<p>The app directory contains the user application files. This is where your custom implementation of the module will live.</p>
<h3><a class="anchor" id="autotoc_md24"></a>
module Folder</h3>
<p>There are a few files present in the directory that are required for operation of the generic module, but are not part of the core CanFest implentation, and thus, are included here.</p>
<p>These files are <a class="el" href="acceltemp_8c.html">acceltemp.c/h</a> and <a class="el" href="eedata_8c.html">eedata.c/h</a>, which are the parts of the program which manage communication with the accelerometer, thermometer, diagnostics measurements, and emulated EEPROM. These files must not be changed unless you know what you're doing.</p>
<dl class="section warning"><dt>Warning</dt><dd>This is particilarly true for the emulated EEPROM, whose configuration and functionality is linked to, and must match the configuration in the module bootloader.</dd></dl>
<h3><a class="anchor" id="autotoc_md25"></a>
Object Dictionary</h3>
<p><a class="el" href="ObjDict_8c.html">ObjDict.c/h</a> are also in this directory, which defines the Object Dictionary from which most of the data communication with FESCAN will take place.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Restricted Peripherals</h1>
<p>There are a few peripherals that are restricted from use in a custom module implementation due to use in the core module functonality. These peripherals are ADC1*, CAN1, TIM2, I2C2, and RCC.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Peripheral   </th><th class="markdownTableHeadNone">Reason    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ADC1*   </td><td class="markdownTableBodyNone">ADC1 is used to measure internal voltages for diagnostics reasons. ADC1 is able to be used if the diagnostics channels are initialized again when additional ADC channels need to be used (as is done in SWARM). If possible, an external ADC is recommended.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">CAN1   </td><td class="markdownTableBodyNone">The CAN interface is used for communication with the broader network.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">TIM2   </td><td class="markdownTableBodyNone">The Timer2 peripheral is used as the timebase for internally timing the CanFest layer.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">I2C2   </td><td class="markdownTableBodyNone">The I2C2 interface is used to communicate with the accelerometer and thermometer on pins PB13 and PB14.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RCC   </td><td class="markdownTableBodyNone">Changing the system clocks requires retiming the TIM2, CAN, I2C, and CanFest, and is not recommended.   </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>If for some reason the user application returns to the bootloader without resetting, the RTC must be deinitialized, or the CAN interface has a significant probability of not working.</dd></dl>
<h1><a class="anchor" id="autotoc_md27"></a>
Configuration Differences</h1>
<p>There are several notable differences between a project generated by STM32CubeIDE and the Generic Remote Module, all relating to the memory mapping of the module.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Core/Src/system_stm32l4xx.c</h2>
<p>The following changes are made to the <a class="el" href="system__stm32l4xx_8c.html">system_stm32l4xx.c</a> file:</p><ul>
<li><code>#define USER_VECT_TAB_ADDRESS</code> - is defined</li>
<li><code>#define VECT_TAB_OFFSET 0x00005000U</code> - changed from 0x00000000U</li>
</ul>
<p>These changes enable the implementation of the custom CAN bootloader.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
STM32L433RCTXP_FLASH.ld</h2>
<p>This is the linker script that defines the addressing of FLASH, RAM, and other important addresses of the microcontroller.</p>
<p>The only change is made to the <em>Memories definiton</em> section.</p>
<div class="fragment"><div class="line">MEMORY</div>
<div class="line">{</div>
<div class="line">  RAM    (xrw)    : ORIGIN = 0x20000000,   LENGTH = 48K</div>
<div class="line">  RAM2    (xrw)    : ORIGIN = 0x10000000,   LENGTH = 16K</div>
<div class="line">  FLASH    (rx)    : ORIGIN = 0x08005000,   LENGTH = 232K</div>
<div class="line">}</div>
</div><!-- fragment --><p>The flash origin has a 0x5000 offset due to the bootloader, and the length is shortened, due to the bootloader, module parameter storage, and reserved EEPROM space.</p>
<p>For a 256K module:</p><ul>
<li>256K - 20K (bootloader) - 2K (parameter space) - 2K (EEPROM) = 232K</li>
</ul>
<h1><a class="anchor" id="autotoc_md30"></a>
Object Dictionary</h1>
<p>The Object Dictionary is the primary index for reading and writing data via FESCAN/CanFest. The <a class="el" href="ObjDict_8c.html">Object Dictionary</a> conatins module configuration data, state information, sensor information, etc; and is where any data you would like to retrieve over FESCAN will live.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Default/Common Entries</h2>
<p>There are several entries in the Object Dictionary which are consistent across all FESCAN/CanFest devices. A non-exhaustive list of entries and their description are included below:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Entry Index   </th><th class="markdownTableHeadNone">Entry Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x1000 - 0x2000   </td><td class="markdownTableBodyNone">CanFest Communication Parameters    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x2003   </td><td class="markdownTableBodyNone">Temperature    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x2010   </td><td class="markdownTableBodyNone">Module Status    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x2011   </td><td class="markdownTableBodyNone">Accelerometer Data    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x2500   </td><td class="markdownTableBodyNone">CAN Statuses    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x2900   </td><td class="markdownTableBodyNone">Restore List    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x3000   </td><td class="markdownTableBodyNone">Diagnostics   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md32"></a>
Adding Entries</h2>
<p>Adding entries to the object dictionary is fairly simple. As an example, we will walk through adding two new entries to the Object Dictionary, SimpleVariable, and SimpleArray.</p>
<h3><a class="anchor" id="autotoc_md33"></a>
Creating Variables</h3>
<p>At the top of <a class="el" href="ObjDict_8c.html">ObjDict.c</a> (located in Core/App/), there is a list of mapped variables. To ensure compatibility with the network, mapped entries should use the built in variable types (<a class="el" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>, <a class="el" href="applicfg_8h.html#a5528eeccf214bfe021532622d78c6a96">UNS16</a>, <a class="el" href="applicfg_8h.html#a889a782714194ae2f780002d25d6e0be">UNS32</a>, <a class="el" href="applicfg_8h.html#a662ebb8e51dc6acbd8850e22f172c5bf">INTEGER8</a>, <a class="el" href="applicfg_8h.html#aef74ac6cf2d7e6e7ceb25199c0a4e8d9">INTEGER16</a>, etc...).</p>
<p>To begin, we will add SimpleVariable (a <a class="el" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>) and SimpleArray (a <a class="el" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>[16]) to the list. Variables that are included in the Object Dictionary must have a default value assigned to them. This value can be updated within the application at any point.</p>
<div class="fragment"><div class="line"><span class="comment">/* ObjDict.c */</span></div>
<div class="line">...</div>
<div class="line">UNS8 Diagnostic_VOS = 0x00;</div>
<div class="line"><a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> Diagnostic_VDD = 0x00;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> SimpleVariable = 0;</div>
<div class="line"><a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> SimpleArray[16] = </div>
<div class="line">{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, </div>
<div class="line">  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };</div>
<div class="ttc" id="aapplicfg_8h_html_a539234687760592d01a8b0d3357bc00e"><div class="ttname"><a href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a></div><div class="ttdeci">#define UNS8</div><div class="ttdoc">Unsigned int8 representation in CANFest.</div><div class="ttdef"><b>Definition</b> <a href="applicfg_8h_source.html#l00025">applicfg.h:25</a></div></div>
</div><!-- fragment --><p>In order for other parts of the program to be able to access these new variables we created, we need to add them to <a class="el" href="ObjDict_8h.html" title="This file is generated by the NNP Tool – Object Dictionary Editor, as originally developed by CAN Fes...">ObjDict.h</a> as an <code>extern</code> variable.</p>
<div class="fragment"><div class="line"><span class="comment">/* ObjDict.h */</span></div>
<div class="line">...</div>
<div class="line">extern <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> Diagnostic_VOS;</div>
<div class="line"><span class="keyword">extern</span> <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> Diagnostic_VDD;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> SimpleVariable;</div>
<div class="line"><span class="keyword">extern</span> <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> SimpleArray[16];</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md34"></a>
Defining Object Dictionary Structures</h3>
<p>With the new entries in the Object Dictionary created, we can now add them into the Object Dictionary itself. Scrolling through the Object Dictionary, you will see the repetition of a specific structure. The one for Accelerometer data is included below:</p>
<div class="fragment"><div class="line"><span class="comment">/* ObjDict.c */</span></div>
<div class="line"><span class="comment">/* index 0x2011 :   Mapped variable Accelerometer Values */</span></div>
<div class="line">                    <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> ObjDict_highestSubIndex_obj2011 = 4; <span class="comment">/* number of subindex - 1*/</span></div>
<div class="line">                    <span class="keyword">const</span> <a class="code hl_struct" href="structtd__subindex.html">subindex</a> ObjDict_Index2011[] =</div>
<div class="line">                     {</div>
<div class="line">                       { RO, uint8, <span class="keyword">sizeof</span> (<a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>), (<span class="keywordtype">void</span>*)&amp;ObjDict_highestSubIndex_obj2011 },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, 4, (<span class="keywordtype">void</span>*)&amp;Accelerometers[0] },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, 4, (<span class="keywordtype">void</span>*) &amp;AccelerometersFiltered[0] },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, int8, 4, (<span class="keywordtype">void</span>*) &amp;AccelerometersTilt[0] },</div>
<div class="line">                       { RO, uint8, 16, (<span class="keywordtype">void</span>*) &amp;Quaternion[0] }</div>
<div class="line">                     };</div>
<div class="ttc" id="aobjdictdef_8h_html_afc4ded33ac0ca43defcce639e965748a"><div class="ttname"><a href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a></div><div class="ttdeci">#define RW</div><div class="ttdef"><b>Definition</b> <a href="objdictdef_8h_source.html#l00060">objdictdef.h:60</a></div></div>
<div class="ttc" id="astructtd__subindex_html"><div class="ttname"><a href="structtd__subindex.html">td_subindex</a></div><div class="ttdef"><b>Definition</b> <a href="objdictdef_8h_source.html#l00071">objdictdef.h:72</a></div></div>
</div><!-- fragment --><p>Indexes and their metadata in the Object Dictionary have a distinct naming structure:</p>
<p>‎<code>ObjDict_IndexXYZW[]</code> &amp; <code>ObjDict_highestSubIndex_objXYZW</code>,</p>
<p>where XYZW is the index address of the mapped variables.</p>
<dl class="section warning"><dt>Warning</dt><dd>Care should be taken to ensure that indexes do not overlap with other module types in the network, this is a preventative measure to ensure mismatched data assignment does not occur between two types of modules. <br  />
<br  />
 e.g, Writing data meant for a Pulse Generator module to a Biopotential module.</dd></dl>
<p>We will create a new entry in the Object Dictionary following the same structure. In this case we will include both variables we created in the same index, but they can easily be split up into different indices if desired.</p>
<dl class="section remark"><dt>Remarks</dt><dd>To keep things organized, variables should be grouped together by function.</dd></dl>
<p>For no particular reason, we will create the new entry at index 0xBEEF.</p>
<div class="fragment"><div class="line"><span class="comment">/* index 0xBEEF :   Mapped variable Simple Test Variables */</span></div>
<div class="line">                    <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> ObjDict_highestSubIndex_objBEEF = 2; <span class="comment">/* number of subindex - 1*/</span></div>
<div class="line">                    <span class="keyword">const</span> <a class="code hl_struct" href="structtd__subindex.html">subindex</a> ObjDict_IndexBEEF[] =</div>
<div class="line">                     {</div>
<div class="line">                       { RO, uint8, <span class="keyword">sizeof</span> (<a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>), (<span class="keywordtype">void</span>*)&amp;ObjDict_highestSubIndex_objBEEF },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, <span class="keyword">sizeof</span> (<a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>), (<span class="keywordtype">void</span>*)&amp;SimpleVariable },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, <span class="keyword">sizeof</span>(SimpleArray), (<span class="keywordtype">void</span>*)&amp;SimpleArray[0] }</div>
<div class="line">                     };</div>
</div><!-- fragment --><ul>
<li><code>ObjDict_highestSubIndex_objBEEF</code> defines how many subindices are present in the given index, and is equal to the number of variables you would like to include.<ul>
<li>The first subindex in an index structure will always be the subindex count.</li>
</ul>
</li>
</ul>
<p>Lets break down the different parts in a <a class="el" href="structtd__subindex.html">subindex</a>:</p><ul>
<li>Variables in an subindex can be assigned as Read Only, <a class="el" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">Read Write</a>, or Write Only across the CAN network, this is useful for something like ADC data, which should only be written to by the module itself, or for our SimpleVariable example, which can be written to or read from.</li>
<li>The next part describes the datatype of the variable, a list of different data types are available in <a class="el" href="objdictdef_8h.html">objdictdef.h</a>.</li>
<li>The next part describes the size of the object in the Object Dictionary. FESCAN has a limit of 48 bytes that can be read across the network in a given request.</li>
<li>The last part describes the object itself. Objects in the Object Dictionary are referenced to by their address. In our case, these are pointers to the SimpleVariable and SimpleArray variables.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>To add an array to the Object Dictionary, the size of the object will be <code>sizeof(array)</code>, but the pointer to the object will be a reference to the 0th index of the array.</dd></dl>
<h3><a class="anchor" id="autotoc_md35"></a>
Registering Object Dictionary Entries</h3>
<p>Now that the Object Dictionary structure is defined, we can register the Object Dictionary entry in the <a class="el" href="objdictdef_8h.html#acd05cef26afde599867f00ba1d48dc45">indextable</a>.</p>
<p>Near the end of <a class="el" href="ObjDict_8c.html">ObjDict.c</a>, there will be a large array named ObjDict_objdict, this is the <a class="el" href="objdictdef_8h.html#acd05cef26afde599867f00ba1d48dc45">indextable</a> of our Object Dictionary.</p>
<p>To register our new index in the Object Dictonary, we can simply add our new entry to the end of the list.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">  { (<a class="code hl_struct" href="structtd__subindex.html">subindex</a>*)ObjDict_Index2020,<span class="keyword">sizeof</span>(ObjDict_Index2020)/<span class="keyword">sizeof</span>(ObjDict_Index2020[0]), 0x2020},</div>
<div class="line">  { (<a class="code hl_struct" href="structtd__subindex.html">subindex</a>*)ObjDict_Index2500,<span class="keyword">sizeof</span>(ObjDict_Index2500)/<span class="keyword">sizeof</span>(ObjDict_Index2500[0]), 0x2500},</div>
<div class="line">  { (<a class="code hl_struct" href="structtd__subindex.html">subindex</a>*)ObjDict_Index2900,<span class="keyword">sizeof</span>(ObjDict_Index2900)/<span class="keyword">sizeof</span>(ObjDict_Index2900[0]), 0x2900},</div>
<div class="line">  { (<a class="code hl_struct" href="structtd__subindex.html">subindex</a>*)ObjDict_Index3000,<span class="keyword">sizeof</span>(ObjDict_Index3000)/<span class="keyword">sizeof</span>(ObjDict_Index3000[0]), 0x3000},</div>
<div class="line">  { (<a class="code hl_struct" href="structtd__subindex.html">subindex</a>*)ObjDict_IndexBEEF,<span class="keyword">sizeof</span>(ObjDict_IndexBEEF)/<span class="keyword">sizeof</span>(ObjDict_IndexBEEF[0]), 0xBEEF}</div>
<div class="line">};</div>
</div><!-- fragment --><p>Additionally, the index must be added to the search function <code>ObjDict_scanIndexOD()</code>.</p>
<div class="fragment"><div class="line">...</div>
<div class="line">        <span class="keywordflow">case</span> 0x2020: i = 18;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2500: i = 19;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2900: i = 20;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x3000: i = 21;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0xBEEF: i = 22;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            *errorCode = OD_NO_SUCH_OBJECT;</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    *errorCode = <a class="code hl_define" href="def_8h.html#acb82b94eb8e368e8c347b2273b6e514e">OD_SUCCESSFUL</a>;</div>
<div class="line">    <span class="keywordflow">return</span> &amp;ObjDict_objdict[i];</div>
<div class="line">}</div>
<div class="ttc" id="adef_8h_html_acb82b94eb8e368e8c347b2273b6e514e"><div class="ttname"><a href="def_8h.html#acb82b94eb8e368e8c347b2273b6e514e">OD_SUCCESSFUL</a></div><div class="ttdeci">#define OD_SUCCESSFUL</div><div class="ttdef"><b>Definition</b> <a href="def_8h_source.html#l00016">def.h:16</a></div></div>
</div><!-- fragment --> <dl class="section important"><dt>Important</dt><dd>Ensure that the index of your new entry in <code>ObjDict_scanIndexOD()</code> aligns with the index in <code>ObjDict_objdict[]</code>.</dd></dl>
<h2>Congratulations! You have added new entries to the Object Dictionary that can be read across the FESCAN network! </h2>
<dl class="section note"><dt>Note</dt><dd>This can be tested by using <em>NNPHELPERS</em> in Matlab: <br  />
<div class="fragment"><div class="line">nnp.write(node, &#39;BEEF&#39;, 1, 42, &#39;uint8&#39;);</div>
</div><!-- fragment --> <div class="fragment"><div class="line">nnp.read(node, &#39;BEEF&#39;, 1);</div>
</div><!-- fragment --> <div class="fragment"><div class="line">nnp.read(node, &#39;BEEF&#39;, 2);</div>
</div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="autotoc_md36"></a>
Adding Callbacks</h2>
<p>Callbacks can be added to specific subindices to call a function when modified in the Object Dictionary via FESCAN. This is useful if a specific variable is used for asynchronous code execution, or as an initialization parameter.</p>
<p>Adding a callback is fairly straightforward, and only requires slight modifications to our existing structures. We will continue from our SimpleVariable example above.</p>
<p>The first modification is at our <code>0xBEEF</code> index:</p>
<div class="fragment"><div class="line"><span class="comment">/* index 0xBEEF :   Mapped variable Simple Test Variables */</span></div>
<div class="line">                    <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> ObjDict_highestSubIndex_objBEEF = 2; <span class="comment">/* number of subindex - 1*/</span></div>
<div class="line">                    ODCallback_t ObjDict_IndexBEEF_callbacks[] =</div>
<div class="line">                     {</div>
<div class="line">                       NULL,</div>
<div class="line">                       NULL,</div>
<div class="line">                       NULL</div>
<div class="line">                     };</div>
<div class="line">                    <span class="keyword">const</span> <a class="code hl_struct" href="structtd__subindex.html">subindex</a> ObjDict_IndexBEEF[] =</div>
<div class="line">                     {</div>
<div class="line">                       { RO, uint8, <span class="keyword">sizeof</span> (<a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>), (<span class="keywordtype">void</span>*)&amp;ObjDict_highestSubIndex_objBEEF },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, <span class="keyword">sizeof</span> (<a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a>), (<span class="keywordtype">void</span>*)&amp;SimpleVariable },</div>
<div class="line">                       { <a class="code hl_define" href="objdictdef_8h.html#afc4ded33ac0ca43defcce639e965748a">RW</a>, uint8, <span class="keyword">sizeof</span>(SimpleArray), (<span class="keywordtype">void</span>*)&amp;SimpleArray[0] }</div>
<div class="line">                     };</div>
</div><!-- fragment --><p> We create a new array <code>ObjDict_IndexBEEF_callbacks[]</code> of type <code>ODCallback_t</code>, that contains as many <code>NULL</code> elements as we have in our subindex table (including subIndex count).</p>
<p>In <code>ObjDict_scanIndexOD</code> we add the set of callbacks to the end of the case statement, so instead of</p>
<div class="fragment"><div class="line">...</div>
<div class="line">        <span class="keywordflow">case</span> 0x2020: i = 18;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2500: i = 19;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2900: i = 20;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x3000: i = 21;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0xBEEF: i = 22;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            *errorCode = OD_NO_SUCH_OBJECT;</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    *errorCode = <a class="code hl_define" href="def_8h.html#acb82b94eb8e368e8c347b2273b6e514e">OD_SUCCESSFUL</a>;</div>
<div class="line">    <span class="keywordflow">return</span> &amp;ObjDict_objdict[i];</div>
<div class="line">}</div>
</div><!-- fragment --><p>like we had before, the table entry will look like this:</p>
<div class="fragment"><div class="line">...</div>
<div class="line">        <span class="keywordflow">case</span> 0x2020: i = 18;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2500: i = 19;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x2900: i = 20;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0x3000: i = 21;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0xBEEF: i = 22;*callbacks = ObjDict_IndexBEEF_callbacks;<span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            *errorCode = OD_NO_SUCH_OBJECT;</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    *errorCode = <a class="code hl_define" href="def_8h.html#acb82b94eb8e368e8c347b2273b6e514e">OD_SUCCESSFUL</a>;</div>
<div class="line">    <span class="keywordflow">return</span> &amp;ObjDict_objdict[i];</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md37"></a>
Registering an Object Dictionary Callback to a Function</h3>
<p>Now that our index in the Object Dictionary has slots for callback functions assigned, we can assign a callback function to it.</p>
<p>All callback functions for the object dictionary must have the following structure:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="applicfg_8h.html#a889a782714194ae2f780002d25d6e0be">UNS32</a> FunctionName(<a class="code hl_struct" href="structstruct__CO__Data.html">CO_Data</a>* d, <span class="keyword">const</span> <a class="code hl_struct" href="structtd__indextable.html">indextable</a> * pIndexTable, <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> bSubindex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Code Execution */</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> ReturnValue;</div>
<div class="line">}</div>
<div class="ttc" id="aapplicfg_8h_html_a889a782714194ae2f780002d25d6e0be"><div class="ttname"><a href="applicfg_8h.html#a889a782714194ae2f780002d25d6e0be">UNS32</a></div><div class="ttdeci">#define UNS32</div><div class="ttdoc">Unsigned int32 representation in CANFest.</div><div class="ttdef"><b>Definition</b> <a href="applicfg_8h_source.html#l00027">applicfg.h:27</a></div></div>
<div class="ttc" id="astructstruct__CO__Data_html"><div class="ttname"><a href="structstruct__CO__Data.html">struct_CO_Data</a></div><div class="ttdoc">This structure contains all necessary informations to define a CANOpen node.</div><div class="ttdef"><b>Definition</b> <a href="data_8h_source.html#l00044">data.h:44</a></div></div>
<div class="ttc" id="astructtd__indextable_html"><div class="ttname"><a href="structtd__indextable.html">td_indextable</a></div><div class="ttdef"><b>Definition</b> <a href="objdictdef_8h_source.html#l00081">objdictdef.h:82</a></div></div>
</div><!-- fragment --><p>In our case, we will add the following function to app.c:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="applicfg_8h.html#a889a782714194ae2f780002d25d6e0be">UNS32</a> SimpleCallback(<a class="code hl_struct" href="structstruct__CO__Data.html">CO_Data</a>* d, <span class="keyword">const</span> <a class="code hl_struct" href="structtd__indextable.html">indextable</a> * unused_indextable, <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> unused_bSubindex)</div>
<div class="line">{</div>
<div class="line">    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_15, !!SimpleVariable); <span class="comment">/* Set PB15 to SimpleVariable */</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>and the following line to app.h:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="applicfg_8h.html#a889a782714194ae2f780002d25d6e0be">UNS32</a> SimpleCallback(<a class="code hl_struct" href="structstruct__CO__Data.html">CO_Data</a>* d, <span class="keyword">const</span> <a class="code hl_struct" href="structtd__indextable.html">indextable</a> * unused_indextable, <a class="code hl_define" href="applicfg_8h.html#a539234687760592d01a8b0d3357bc00e">UNS8</a> unused_bSubindex);</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>If multiple entries in the Object Dictionary use the same callback function, the indexTable and bSubindex parameters can be used to differentiate them.</dd></dl>
<p>In <a class="el" href="group__application.html#ga42c42e16b97b7f73d30718595c902889">initAppTask()</a> we call the following function to register a change in SimpleVariable to our newly created function.</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__od.html#ga514e7b9c13835a86446b1cd38fa34049">RegisterSetODentryCallBack</a>(&amp;ObjDict_Data, 0xBEEF, 0x01, &amp;SimpleCallback);</div>
<div class="ttc" id="agroup__od_html_ga514e7b9c13835a86446b1cd38fa34049"><div class="ttname"><a href="group__od.html#ga514e7b9c13835a86446b1cd38fa34049">RegisterSetODentryCallBack</a></div><div class="ttdeci">UNS32 RegisterSetODentryCallBack(CO_Data *d, UNS16 wIndex, UNS8 bSubindex, ODCallback_t Callback)</div><div class="ttdoc">&lt;BRIEF&gt;</div><div class="ttdef"><b>Definition</b> <a href="objacces_8c_source.html#l00357">objacces.c:357</a></div></div>
</div><!-- fragment --><h2>Congratulations! You have added a callback that runs when a variable in the Object Dictionary is updated! </h2>
<h2><a class="anchor" id="autotoc_md38"></a>
Add to Restore List</h2>
<p>Indices in the Object Dictionary can be restored if they are included in the RestoreList entry in the ObjectDictionary (0x2900). A given state of the Object Dictionary can be saved via the <a class="el" href="group__EEPROM.html#gabdbcc16ecac7cbd0adad6cfc5805ae54">SaveValues()</a> function, or over the CAN network via the NMT_Do_Save_Cmd NMT command.</p>
<p>We will add our example index <code>0xBEEF</code> to the restore list.</p>
<div class="fragment"><div class="line"><span class="comment">/* ObjDict.c */</span></div>
<div class="line"><a class="code hl_define" href="applicfg_8h.html#a5528eeccf214bfe021532622d78c6a96">UNS16</a> RestoreList[RESTORE_COUNT] =  { 0x1400, <span class="comment">/*RPDO Params(10)*/</span> \</div>
<div class="line">                                      0x1600, <span class="comment">/*RPDO Mapping(32)*/</span> \</div>
<div class="line">                                      0x1800, <span class="comment">/*TPDO Params(10)*/</span> \</div>
<div class="line">                                      0x1A00, <span class="comment">/*TPDO Mapping(32)*/</span> \</div>
<div class="line">                                      0x2001, <span class="comment">/*Control(4)*/</span>\</div>
<div class="line">                                      0x2012, <span class="comment">/*Accelerometer Settings*/</span>\</div>
<div class="line">                                      0xBEEF  <span class="comment">/*SimpleVariable/Array*/</span>};</div>
<div class="ttc" id="aapplicfg_8h_html_a5528eeccf214bfe021532622d78c6a96"><div class="ttname"><a href="applicfg_8h.html#a5528eeccf214bfe021532622d78c6a96">UNS16</a></div><div class="ttdeci">#define UNS16</div><div class="ttdoc">Unsigned int16 representation in CANFest.</div><div class="ttdef"><b>Definition</b> <a href="applicfg_8h_source.html#l00026">applicfg.h:26</a></div></div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>Ensure that the RESTORE_COUNT in <code><a class="el" href="ObjDict_8h.html" title="This file is generated by the NNP Tool – Object Dictionary Editor, as originally developed by CAN Fes...">ObjDict.h</a></code> lines up with the number of indices in <code>RestoreList</code>, otherwise, you will get a compilation error</dd></dl>
<h1><a class="anchor" id="autotoc_md39"></a>
Adding Functionality</h1>
<p>Application functionality is added via source/header files within the Core/app directory. Instead of a <a class="el" href="main_8c.html" title=": Main program body">main.c</a>, the module application code should live in <a class="el" href="app_8c.html">app.c</a>.</p>
<p>Initialization code takes place in <a class="el" href="group__application.html#ga42c42e16b97b7f73d30718595c902889">initAppTask()</a>, and the continuously running loop takes place in <a class="el" href="group__application.html#gafdedae5c2185b828122616a752251cd1">updateAppTask()</a>.</p>
<p>There are also several useful callbacks present in <a class="el" href="app_8c.html">app.c</a> that are linked to FESCAN/CanFest functionality.</p>
<ul>
<li><a class="el" href="group__application.html#ga029280b253d1107ff9e68f7fa86d7ab5">processSYNCMessageForApp()</a> - Called when a SYNC message is received, check documentation for details.</li>
<li><a class="el" href="group__application.html#ga41a8e42e20a44bbe2603bb3c6e8fb204">sleepApplication()</a> - Allows the user application to put any peripherals into a low power state before the module enters a low power state.</li>
<li><a class="el" href="group__application.html#gaca63e0eddadac7318018fb262a07c249">InitAppTaskValues()</a> - Reinitializes user application values, check documentation for details.</li>
</ul>
<p>State management callbacks are also available for user application modification.</p>
<dl class="section important"><dt>Important</dt><dd>Do not modify <a class="el" href="main_8c.html" title=": Main program body">main.c</a>, outside of changes from modifying STM_RM.ioc. Application code should live in Core/app</dd></dl>
<p>An example of implemented application code is locally present in <a class="el" href="acceltemp_8c.html">acceltemp.c</a>, with a full application example in SWARM.</p>
<h2><a class="anchor" id="autotoc_md40"></a>
STM_RM.ioc</h2>
<p>‎<code>STM_RM.ioc</code> is the STM32CubeMX configuration file that enables creation of initialization code for pin function and system clocks through a GUI.</p>
<p>As long as the existing set up peripherals and pin assignments are not modified, the ioc file can be used to add additional peripherals and GPIO to the project.</p>
<dl class="section note"><dt>Note</dt><dd>STM_RM.ioc must be renamed to match the name of the folder that contains it. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
